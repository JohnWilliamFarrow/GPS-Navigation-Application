// var object = { "@type": "PagedGpsMessageResult", "index": 0, "limit": 100, "count": 35, "total": 35, "gpsMessage": [{ "messageTime": "2019-01-11T18:38:56Z", "satellite": false, "latitude": 36.731307, "longitude": -76.201956, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T18:38:56Z", "value": 97721.12 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 0, "maxSpeed": 0, "vehicleId": 717682 }, { "messageTime": "2019-01-12T15:59:17Z", "satellite": false, "latitude": 36.473813, "longitude": -79.826844, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-12T15:59:17Z", "value": 61852.27 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 15, "maxSpeed": 48, "vehicleId": 868716 }, { "messageTime": "2019-01-11T17:25:56Z", "satellite": false, "latitude": 43.103431, "longitude": -88.143076, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T17:25:56Z", "value": 92789.31 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 0, "maxSpeed": 0, "vehicleId": 680780 }, { "messageTime": "2018-02-12T15:05:20Z", "satellite": false, "latitude": 33.841422, "longitude": -84.320711, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2018-02-12T15:05:20Z", "value": 214833.31 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 1, "maxSpeed": 12, "vehicleId": 837619 }, { "messageTime": "2019-01-11T16:42:43Z", "satellite": false, "latitude": 32.88, "longitude": -83.76384, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T16:42:43Z", "value": 26584.81 }, "keyOn": true, "parked": false, "lastSpeed": 0, "avgSpeed": 16, "maxSpeed": 40, "vehicleId": 863025 }, { "messageTime": "2019-01-12T16:58:39Z", "satellite": false, "latitude": 29.813689, "longitude": -81.27104, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-12T16:58:39Z", "value": 255148.33 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 7, "maxSpeed": 31, "vehicleId": 837937 }, { "messageTime": "2019-01-11T16:52:40Z", "satellite": false, "latitude": 33.427982, "longitude": -86.929849, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T16:52:40Z", "value": 62221.46 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 2, "maxSpeed": 14, "vehicleId": 900765 }, { "messageTime": "2019-01-11T20:00:41Z", "satellite": false, "latitude": 39.659876, "longitude": -104.756551, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T20:00:41Z", "value": 40784.44 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 2, "maxSpeed": 14, "vehicleId": 876391 }, { "messageTime": "2019-01-11T11:42:06Z", "satellite": false, "latitude": 30.177778, "longitude": -95.201493, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T11:42:06Z", "value": 95693.97 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 0, "maxSpeed": 0, "vehicleId": 777730 }, { "messageTime": "2019-01-11T17:48:39Z", "satellite": false, "latitude": 28.628764, "longitude": -81.315911, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T17:48:39Z", "value": 105805.45 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 0, "maxSpeed": 0, "vehicleId": 699220 }, { "messageTime": "2019-01-12T08:42:05Z", "satellite": false, "latitude": 34.094649, "longitude": -118.034347, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-12T08:42:05Z", "value": 54376.09 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 0, "maxSpeed": 5, "vehicleId": 840382 }, { "messageTime": "2018-01-31T18:19:04Z", "satellite": false, "latitude": 29.991964, "longitude": -95.174187, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2018-01-31T18:19:04Z", "value": 431.81 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 7, "maxSpeed": 27, "vehicleId": 900836 }, { "messageTime": "2019-01-11T20:16:12Z", "satellite": false, "latitude": 32.11776, "longitude": -90.281529, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T20:16:12Z", "value": 61147.09 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 4, "maxSpeed": 17, "vehicleId": 884808 }, { "messageTime": "2019-01-11T18:08:44Z", "satellite": false, "latitude": 35.469867, "longitude": -80.743253, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T18:08:44Z", "value": 111175.28 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 7, "maxSpeed": 45, "vehicleId": 541592 }, { "messageTime": "2019-01-12T16:47:46Z", "satellite": false, "latitude": 31.057636, "longitude": -87.517867, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-12T16:47:46Z", "value": 80366.0 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 4, "maxSpeed": 12, "vehicleId": 837928 }, { "messageTime": "2019-01-11T18:18:13Z", "satellite": false, "latitude": 27.767751, "longitude": -82.329173, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T18:18:13Z", "value": 247545.65 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 4, "maxSpeed": 17, "vehicleId": 704381 }, { "messageTime": "2016-04-09T13:43:17Z", "satellite": false, "latitude": 33.567502, "longitude": -84.498702, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2016-04-09T13:43:17Z", "value": 33624.26 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 1, "maxSpeed": 5, "vehicleId": 535095 }, { "messageTime": "2019-01-11T18:52:52Z", "satellite": false, "latitude": 25.932516, "longitude": -80.157796, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T18:52:52Z", "value": 29402.92 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 0, "maxSpeed": 0, "vehicleId": 886933 }, { "messageTime": "2019-01-11T21:47:30Z", "satellite": false, "latitude": 33.59296, "longitude": -112.231324, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T21:47:30Z", "value": 25576.45 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 12, "maxSpeed": 34, "vehicleId": 558973 }, { "messageTime": "2019-01-11T22:42:10Z", "satellite": false, "latitude": 38.424036, "longitude": -121.428338, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T22:42:10Z", "value": 161468.61 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 0, "maxSpeed": 0, "vehicleId": 615135 }, { "messageTime": "2019-01-12T02:03:11Z", "satellite": false, "latitude": 40.688498, "longitude": -111.910258, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-12T02:03:11Z", "value": 53249.16 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 6, "maxSpeed": 25, "vehicleId": 906046 }, { "messageTime": "2019-01-11T23:32:20Z", "satellite": false, "latitude": 32.547769, "longitude": -93.716196, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T23:32:20Z", "value": 179171.49 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 1, "maxSpeed": 5, "vehicleId": 639461 }, { "messageTime": "2019-01-11T20:19:39Z", "satellite": false, "latitude": 32.716089, "longitude": -96.603307, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T20:19:39Z", "value": 79414.66 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 5, "maxSpeed": 20, "vehicleId": 784181 }, { "messageTime": "2019-01-11T20:21:57Z", "satellite": false, "latitude": 41.732764, "longitude": -83.524907, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T20:21:57Z", "value": 158624.43 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 5, "maxSpeed": 20, "vehicleId": 627403 }, { "messageTime": "2019-01-11T18:53:29Z", "satellite": false, "latitude": 33.956836, "longitude": -118.163769, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T18:53:29Z", "value": 137558.92 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 0, "maxSpeed": 0, "vehicleId": 362699 }, { "messageTime": "2019-01-08T15:04:14Z", "satellite": false, "latitude": 26.441671, "longitude": -80.071467, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-08T15:04:14Z", "value": 35410.73 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 6, "maxSpeed": 15, "vehicleId": 894730 }, { "messageTime": "2019-01-11T20:53:40Z", "satellite": false, "latitude": 38.972018, "longitude": -84.279751, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T20:53:40Z", "value": 24866.14 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 1, "maxSpeed": 9, "vehicleId": 930373 }, { "messageTime": "2019-01-12T16:23:44Z", "satellite": false, "latitude": 38.986951, "longitude": -94.276409, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-12T16:23:44Z", "value": 29555.79 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 0, "maxSpeed": 1, "vehicleId": 928176 }, { "messageTime": "2018-12-06T22:52:38Z", "satellite": false, "latitude": 34.941867, "longitude": -82.28032, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2018-12-06T22:52:38Z", "value": 77892.26 }, "keyOn": true, "parked": false, "lastSpeed": 6, "avgSpeed": 19, "maxSpeed": 35, "vehicleId": 927551 }, { "messageTime": "2019-01-10T23:48:37Z", "satellite": false, "latitude": 33.904427, "longitude": -81.321387, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-10T23:48:37Z", "value": 84020.21 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 0, "maxSpeed": 0, "vehicleId": 721340 }, { "messageTime": "2019-01-11T18:55:34Z", "satellite": false, "latitude": 41.555413, "longitude": -88.151111, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T18:55:34Z", "value": 234161.54 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 0, "maxSpeed": 7, "vehicleId": 711929 }, { "messageTime": "2019-01-12T17:24:03Z", "satellite": false, "latitude": 33.208107, "longitude": -87.556267, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-12T17:24:03Z", "value": 33925.13 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 2, "maxSpeed": 15, "vehicleId": 720829 }, { "messageTime": "2017-10-13T20:05:06Z", "satellite": false, "latitude": 28.008889, "longitude": -82.299164, "accuracy": { "@units": "MILES", "value": 0.012427423844746679 }, "odometer": { "@units": "MILES", "@timestamp": "2017-10-13T20:05:06Z", "value": 9194.36 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 0, "maxSpeed": 0, "vehicleId": 853393 }, { "messageTime": "2019-01-11T21:02:30Z", "satellite": false, "latitude": 32.331164, "longitude": -86.262329, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-11T21:02:30Z", "value": 57129.9 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 0, "maxSpeed": 0, "vehicleId": 849829 }, { "messageTime": "2019-01-12T16:09:29Z", "satellite": false, "latitude": 33.826489, "longitude": -79.74336, "accuracy": { "@units": "MILES", "value": 0.006213711922373339 }, "odometer": { "@units": "MILES", "@timestamp": "2019-01-12T16:09:29Z", "value": 309889.45 }, "keyOn": false, "parked": false, "lastSpeed": 0, "avgSpeed": 0, "maxSpeed": 6, "vehicleId": 837892 }] };

var object;

// Initialize Firebase
var config = {
    apiKey: "AIzaSyDHsDtXHobDvK-Ja0rwoaU23rF1HEK44CE",
    authDomain: "gps-tracking-app-43247.firebaseapp.com",
    databaseURL: "https://gps-tracking-app-43247.firebaseio.com",
    projectId: "gps-tracking-app-43247",
    storageBucket: "gps-tracking-app-43247.appspot.com",
    messagingSenderId: "534735139379"
};
firebase.initializeApp(config);

var database = firebase.database();

var message = firebase.functions().httpsCallable('getVehicleData');

callAPI();

function callAPI() {
    // When you dont want to send arguments to CF. Use '()'
    message().then(function (result) {

        object = JSON.parse(result.data);
        runCode();

    }).catch(function (error) {

        console.log('error', error)
    });
}

$('#refresh').on('click', function () {
    var getVehicleById = firebase.functions().httpsCallable('getVehicleById');
    var driverId;


    database.ref().on('value', function (snapshot) {
        driverId = snapshot.val().name;
        console.log(driverId);
    })

    // When you want to send arguments to CF.
    getVehicleById({ text: driverId }).then(function (result) {

        var refreshObject = JSON.parse(result.data);
        console.log(refreshObject);
        var path = refreshObject.gpsMessage[refreshObject.gpsMessage.length - 1];
        var lat = path.latitude;
        var lng = path.longitude;

        database.ref().set({
            name: driverId,
            latitude: lat,
            longitude: lng
        });

    }).catch(function (error) {

        console.log('error', error)
    });
})

function runCode() {

    var array = [];

    driverArray();

    function driverArray() {

        for (var i = 0; i < object.gpsMessage.length; i++) {
            var driverInfo = {
                'driverId': object.gpsMessage[i].vehicleId,
                'keyOn': object.gpsMessage[i].keyOn,
                'lastSpeed': object.gpsMessage[i].lastSpeed,
                'latitude': object.gpsMessage[i].latitude,
                'longitude': object.gpsMessage[i].longitude
            }

            array.push(driverInfo);
        }
        // database.ref().set({
        //     drivers: array
        // });

    }

    $('#search-button').on('click', function (event) {

        event.preventDefault();

        var searchInput = $('#driver-search').val();
        console.log(searchInput);

        var counter = 0;

        for (var i = 0; i < array.length; i++) {

            if (searchInput == array[i].driverId) {
                $('#drivers').empty()

                driverId = array[i].driverId;
                var movement = $('<p>');
                var movementIndicator = $('<span>');
                if (object.gpsMessage[i].keyOn === false) {
                    movement.text('Stopped').attr('class', 'movement');
                    movementIndicator.attr('class', 'redDot')
                } else if (object.gpsMessage[i].keyOn === true && object.gpsMessage[i].lastSpeed === 0) {
                    movement.text('Idle').attr('class', 'movement');
                    movementIndicator.attr('class', 'blueDot')
                } else {
                    movement.text('Active').attr('class', 'movement');
                    movementIndicator.attr('class', 'greenDot')
                }

                var driverLink = $('<a>').attr('href', 'driver-snapshot.html');
                var driverDiv = $('<div>').attr('class', 'driver').attr('id', `driver-${i}`);
                var driver = $('<p>').text(driverId).attr('class', 'driverID');

                driverDiv.append(driver);
                driverDiv.append(movementIndicator);
                driverDiv.append(movement);
                driverLink.append(driverDiv);


                $('#drivers').append(driverLink);
                counter++;
            }

            if (i === 34 && counter === 0) {
                $('#drivers').empty();

                var errorMessage = $('<span>').attr('id', 'errorMessage');
                errorMessage.text('Driver does not exist :(');

                $('#drivers').append(errorMessage);
            }

        }
    })

    for (var i = 0; i < array.length; i++) {

        var driverId = array[i].driverId;
        var movement = $('<p>');
        var movementIndicator = $('<span>');

        if (object.gpsMessage[i].keyOn === false) {
            movement.text('Stopped').attr('class', 'movement');
            movementIndicator.attr('class', 'redDot')
        } else if (object.gpsMessage[i].keyOn === true && object.gpsMessage[i].lastSpeed === 0) {
            movement.text('Idle').attr('class', 'movement');
            movementIndicator.attr('class', 'blueDot')
        } else {
            movement.text('Active').attr('class', 'movement');
            movementIndicator.attr('class', 'greenDot')
        }

        var driverLink = $('<a>').attr('href', 'driver-snapshot.html');
        var driverDiv = $('<div>').attr('class', 'driver').attr('id', `driver-${i}`);
        var driver = $('<p>').text(driverId).attr('class', 'driverID');

        driverDiv.append(driver);
        driverDiv.append(movementIndicator);
        driverDiv.append(movement);
        driverLink.append(driverDiv);


        $('#drivers').append(driverLink);

    }

    console.log(array);

    $('#drivers').on('click', '.driver', function () {
        var driver = $(this).attr('id');

        extractNumber(driver);

        function extractNumber(value) {
            var split;

            if (value.includes("-") > 0) {
                split = value.split("-")
            }
            console.log(split);

            str = split[1];

            return str;
        };

        var driverId = array[str].driverId;
        var lat = array[str].latitude;
        var lng = array[str].longitude;

        database.ref().set({
            name: driverId,
            latitude: lat,
            longitude: lng
        });

    })

};

// Google Maps API
function initMap() {

    database.ref().on('value', function (snapshot) {
        var driverChosen = snapshot.val();

        var driverName = driverChosen.name;
        var lat = driverChosen.latitude;
        var lng = driverChosen.longitude;

        $('#driverName').text(driverName);

        var myLatLng = { lat: lat, lng: lng };

        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 16,
            center: myLatLng
        });

        var marker = new google.maps.Marker({
            position: myLatLng,
            map: map,
            title: 'Hello World!'
        });

        $('body').attr('style', 'visibility: show;')

    })

}